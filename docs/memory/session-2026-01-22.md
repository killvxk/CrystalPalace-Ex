# 会话记录 2026-01-22

## 完成的任务

### 从 F:\cp26\cpsrc 同步代码到本项目

**背景**：本项目 (F:\cpsrc) 基于初始提交后添加了一个 stdcall 修复。需要将 F:\cp26\cpsrc 的新修改同步过来，同时保留本项目的修复。

**本项目已有的修复**：
- `ParseImport.java` 第 127-129 行的 stdcall 装饰符号处理
- 当导入符号有 `@N` 后缀（stdcall 调用约定）且有模块名时，去除函数名的前导下划线
- 例如：`__imp_KERNEL32$_SomeFunction@8` → 函数名解析为 `SomeFunction` 而非 `_SomeFunction`

## 同步内容

### 新增文件（10 个）
| 文件路径 | 说明 |
|---------|------|
| `src/crystalpalace/btf/FilterCode.java` | 代码过滤接口 |
| `src/crystalpalace/btf/RebuildConfig.java` | 重建配置类 |
| `src/crystalpalace/btf/lttl/Blocks.java` | 代码块分析 |
| `src/crystalpalace/btf/lttl/DirtyLeaves.java` | 脏叶节点追踪 |
| `src/crystalpalace/btf/lttl/Jumps.java` | 跳转处理（从 btf/ 移动） |
| `src/crystalpalace/btf/lttl/LocalLabels.java` | 本地标签管理 |
| `src/crystalpalace/btf/lttl/PassThrough.java` | 透传处理 |
| `src/crystalpalace/btf/lttl/RelocationFix.java` | 重定位修复 |
| `src/crystalpalace/btf/lttl/Relocations.java` | 重定位处理 |
| `src/crystalpalace/btf/lttl/SavedRegContext.java` | 寄存器上下文保存 |
| `src/crystalpalace/btf/lttl/Zones.java` | 区域分析（从 btf/ 移动） |
| `src/crystalpalace/btf/pass/MiniFrame.java` | 迷你栈帧处理 |
| `src/crystalpalace/btf/pass/MultiFilter.java` | 多重过滤器 |
| `src/crystalpalace/btf/pass/easypic/FixBaseX86.java` | x86 基址修复 |
| `src/crystalpalace/btf/pass/mutate/BlockParty.java` | 块变异 |
| `src/crystalpalace/btf/pass/mutate/RegDance.java` | 寄存器变换 |
| `src/crystalpalace/btf/pass/mutate/Shatter.java` | 代码分散 |
| `src/crystalpalace/coff/SectionExport.java` | 节导出 |

### 删除文件（2 个）
| 文件路径 | 原因 |
|---------|------|
| `src/crystalpalace/btf/Jumps.java` | 移动到 lttl 子包 |
| `src/crystalpalace/btf/Zones.java` | 移动到 lttl 子包 |

### 更新文件（38 个）
主要涉及：
- `btf/` 包：CodeUtils, CodeX64, CodeX86, Modify, Rebuilder, RebuildStep
- `btf/pass/` 包：BaseModify, CallWalk
- `btf/pass/easypic/` 包：DangerWalk, FixBSSReferencesX64, FixBSSReferencesX86, FixX86References, ResolveAPI
- `btf/pass/hook/` 包：Attach
- `btf/pass/mutate/` 包：GoFirst, LinkTimeOptimizer, Mutator
- `coff/` 包：COFFObject, COFFParser, COFFWalker, Relocation, Section, SectionFlags, Symbol
- `export/` 包：ExportObject, ProgramCOFF, ProgramPIC, ProgramPICO, SectionContainer
- `merge/` 包：COFFList, COFFMerge
- `spec/` 包：LinkerCLI, LinkSpec, SpecParser, SpecProgram
- `util/` 包：CommandParser

### 保留的本项目修改
- `ParseImport.java` 的 stdcall 修复（第 127-129 行）未被覆盖

### 恢复的本项目修改（同步时被覆盖，已恢复）

#### 1. 重复符号名支持
- `COFFWalker.java` 的 Symbol 类添加 `uniqueName` 字段和 `setUniqueName()` 方法
- `COFFWalker.java` 的 Header 类添加 `resolveSymbolNameConflicts()` 方法：检测重复符号名并分配唯一名称（`name#index` 格式）
- `COFFParser.java` 更新注释说明符号名现在由 `resolveSymbolNameConflicts()` 保证唯一性

#### 2. 动态入口符号检测
- `COFFObject.java` 的 `findEntrySymbol()` 方法：查找入口符号，支持 go/_go/__go 及 @N 后缀
- `COFFObject.java` 的 `findEntrySymbolName()` 方法：从函数名映射中查找入口符号名
- `SectionContainer.java` 的 `findEntrySymbol()` 方法：在 SectionContainer 中查找入口符号
- `ProgramPIC.java` 的 `checkGoFirst()` 方法：使用 `findEntrySymbol()` 替代硬编码符号名
- `GoFirst.java` 的 `apply()` 方法：使用 `COFFObject.findEntrySymbolName()` 替代硬编码符号名
- `LinkTimeOptimizer.java` 的 `apply()` 方法：使用 `COFFObject.findEntrySymbolName()` 替代硬编码符号名

#### 3. COFF 导出限制
- `SpecProgram.java` 的 COFF linkfunc 检查：禁止对 COFF 导出使用 linkfunc 命令

#### 4. 入口符号名获取
- `ExportObject.java` 的 `getEntrySymbolName()` 方法：优先使用 findEntrySymbol() 查找入口符号

### 保留的本项目独有文件
- `.gitignore`
- `CLAUDE.md`
- `README.md`
- `src/crystalpalace/export/LinkedSections.java`（未使用，暂保留）

## 技术决策

### ADR-001: lttl 子包结构

**状态**：已采纳

**背景**：cp26 将 `Jumps.java` 和 `Zones.java` 从 `btf/` 移动到 `btf/lttl/` 子包，并添加了更多相关类。

**决策**：采纳 cp26 的 lttl 子包结构，删除本项目旧的 btf/Jumps.java 和 btf/Zones.java。

**理由**：
- lttl 包提供了更好的代码组织
- 新增了 Blocks、DirtyLeaves、LocalLabels 等相关类
- Rebuilder.java 等核心类已更新为使用 lttl 包

### ADR-002: 保留 stdcall 修复

**状态**：已采纳

**背景**：本项目在 ParseImport.java 中有一个 stdcall 装饰符号的修复，cp26 没有这个修复。

**决策**：保留本项目的 stdcall 修复，不从 cp26 复制 ParseImport.java。

**理由**：
- 修复解决了 stdcall 导入函数名解析问题
- 修复逻辑正确，不影响其他功能
- 所有使用 ParseImport 的代码路径都会受益

## 验证结果

- 编译通过：`ant clean && ant` 成功
- stdcall 修复验证：代码逻辑正确，调用路径完整
- 新增 lttl 包引用验证：所有导入语句正确
